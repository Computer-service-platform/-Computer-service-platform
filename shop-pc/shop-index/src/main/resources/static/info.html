<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>提交订单信息</title>
<link href="css/style.css" type="text/css" rel="stylesheet" />
<script src="js/jquery-1.7.min.js" type="text/javascript"></script>
<script src="js/common.js"  type="text/javascript"></script>

</head>
<body class="index">
<div class="top_ad"><div class="w1200"><a href="#" id="close"></a></div></div>
<div id="yc_login">
<div class="top">
	<div class="w1200">
		<div class="left">您好，欢迎光临易易城！
			<div v-if="onlogin"><em>[{{user.nickName}}]&nbsp;&nbsp;&nbsp;</em><a href="javascript:void(0)" @click="out()">[注销]</a>
			</div>
			<div v-if="outlogin">
				<a href="login.html">[登录]</a> <a href="reg.html">[注册]</a>
			</div>
		</div>
        <div class="right"><a href="member.html">我的会员中心</a>|<a href="#">服务中心</a>|<a href="#">在线客服</a>|<a href="shopcar.html">购物车<b>{{goodsCount}}</b>件</a></div>
        <div class="clear"></div>
    </div>


<div class="head">
	<div class="w1200">
    	<div class="logo"><a href="index.html"></a></div>
        <div class="s_r">
        	<dl>
            	<dt><a>购物车<span>{{goodsCount}}</span></a></dt>
                <dd>客服电话：<b>400-0139-038</b></dd>
            </dl>
        </div>
        <div class="clear"></div>
    </div>
</div>
</div>



<div style="margin-top: 130px"class="w1200">
	<div class="position"><a href="index.html">首页</a> > <a href="shopcar.html">购物车</a></div>
    
    <div class="shopcar">
    	<div class="info_lc"><span class="sp01">我的购物车</span><span class="sp02">填写提交信息表单</span><span class="sp03">在线支付</span></div>
      	
        <dl class="info">
        	<dt><span>确认收货地址</span></dt>
            <dd>
            	<div class="item"><span><font>*</font>所在地区：</span>
					<select v-model="i">
						<option v-for='(prov,index) of provs' :key='index' :value='index' v-text='prov'></option>
					</select>
					<select v-model="j">
						<option v-for='(city,index) of cities[i]' :key='index' :value='index' v-text='city'></option>
					</select>						
					<input type="text" class="txt"  v-model="detail"/>
            	</div>
            	<div class="item"><span><font>*</font>邮政编码：</span><input type="text" class="txt" v-model="pcode"/></div>
                <div class="item">
                	<table width="100%" border="0" cellspacing="0" cellpadding="0">
                      <tr>
                        <td width="8%"><span><font>*</font>详细地址：</span></td>
                        <td width="92%"><textarea v-model="detailAddr"></textarea></td>
                      </tr>
                    </table>
                </div>
                <div class="item"><span><font>*</font>收货人姓名：</span><input type="text" class="txt" v-model="receiver"/></div>
                <div class="item"><span><font>*</font>手机：</span><input type="text" class="txt" v-model="tel"/></div>
            </dd>
        </dl>
        
        <dl>
        	<dt><span>确认订单信息</span></dt>
            <dd>
            	<table width="100%" cellpadding="0" cellspacing="0" border="0">
                  <tr class="tr_t">
                  	<td width="2%">&nbsp;</td>
                    <td width="48%">商品</td>
                    <td width="25%">单价</td>
                    <td width="13%">数量</td>
                    <td width="12%">小计</td>
                  </tr>
                  <tr class="tr_c" v-for="(item,index) in buyCarts">
                  	<td>&nbsp;</td>
                    <td>
                    	<table width="100%" border="0" cellspacing="0" cellpadding="0">
                          <tr>
                            <td width="15%"><img :src="item.showPic"/></td>
                            <td width="85%"><a :href="'product_show.html#'+item.sizeno" class="title">{{item.gname}}-{{item.size}}</a></td>
                          </tr>
                        </table>
                    </td>
                    <td class="price">￥ {{item.price}}</td>
                    <td>{{item.num}}</td>
                    <td class="price">￥ {{money[index]}}</td>
                  </tr>
                  <tr class="tr_d">
                    <td colspan="7">
                    	<table width="100%" border="0" cellspacing="0" cellpadding="0">
                          <tr>
                          	<td width="3%">&nbsp;</td>
                            <td width="6%">买家留言：</td>
                            <td width="75%"><input v-model="word" type="text" class="msg"/></td>
                            <td width="6%">应付金额：</td>
                            <td width="10%" class="all_price"><font>￥ {{totalPrice}}</font></td>
                          </tr>
                        </table>
                    </td>
                  </tr>
                </table>
                <div class="clear"></div>
                
   		  </dd>
        </dl>
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="go_tb">
         <tr>
           <td width="20%"><a href="product.html" class="go_buy">继续购物</a></td>
           <td width="63%">&nbsp;</td>
           <td width="17%" align="right"><a href="javascript:void(0)" @click="genOrder()" class="code">结 算</a></td>
         </tr>
        </table>
        <div class="clear"></div>
    </div>
</div>
</div>
<!--footer-->
<div class="footer">
	<div class="f_bz">
    	<div class="w1200">
            <dl class="dl01">
                <dt>正品保证</dt>
                <dd>正品护航  购物无忧</dd>
            </dl>
            <dl class="dl02">
                <dt>你消费 我买单</dt>
                <dd>返现购物商城</dd>
            </dl>
            <dl class="dl03">
                <dt>品类丰富</dt>
                <dd>品类齐全 轻松购物</dd>
            </dl>
            <dl class="dl04">
                <dt>特色服务体验</dt>
                <dd>为您呈现不一样的服务</dd>
            </dl>
            <div class="clear"></div>
        </div>
    </div>
	<div class="f_nav">
    	<div class="w1200">
            <dl>
                <dt>新手指南</dt>
                <dd>
                    <a href="#">注册新用户</a>
                    <a href="#">商品订购流程</a>
                    <a href="#">会员注册协议</a>
                </dd>
            </dl>
            <dl>
                <dt>付款方式</dt>
                <dd>
                    <a href="#">支付宝支付</a>
                    <a href="#">网上银行支付</a>
                    <a href="#">货到付款</a>
                </dd>
            </dl>
            <dl>
                <dt>常见问题</dt>
                <dd>
                    <a href="#">订单状态</a>
                    <a href="#">发票说明</a>
                </dd>
            </dl>
            <dl>
                <dt>售后服务</dt>
                <dd>
                    <a href="#">退换货政策</a>
                    <a href="#">退换货流程</a>
                    <a href="#">退款说明</a>
                    <a href="#">退换货申请</a>
                </dd>
            </dl>
            <dl>
                <dt>客服中心</dt>
                <dd>
                    <a href="#">常见问题</a>
                    <a href="#">联系客服</a>
                    <a href="#">投诉与建议</a>
                </dd>
            </dl>
            <div class="ewm"><img src="images/home/ico35.png"/></div>
            <div class="ewm"><img src="images/home/ico38.png"/></div>
            <div class="clear"></div>
        </div>
    </div>
    <div class="w1200">
        <div class="bottom">
            <a href="#">关于我们</a>|<a href="#">帮助中心</a>|<a href="#">法律声明</a>|<a href="#">用户协议</a>|<a href="#">联系我们</a>|<a href="#">人才招聘</a>|<a href="#">站点地图</a>
           
            <p>网络文化经营许可证：粤网文[2015]0295-065号<br />© 2015 深圳易易城科技网络有限公司. 粤ICP备15042543号</p>
            <p class="p02"><img src="images/home/ico25.jpg"/><img src="images/home/ico26.jpg"/><img src="images/home/ico27.jpg"/><img src="images/home/ico36.jpg"/><img src="images/home/ico37.jpg"/></p>
        </div>
    </div>
</div>
<!--float_right-->
<div class="float">
	<ul>
    	<li><a href="#" class="a01"></a></li>
        <li><a href="#" class="a02"></a></li>
        <li><a href="#" class="a03"></a></li>
        <li><a href="#" class="a04"></a></li>
    </ul>
</div>
<script type="text/javascript" src="js/vue.min.js"></script>
<script type="text/javascript" src="js/axios.min.js"></script>
<script type="text/javascript" src="js/qs.js"></script>
<script>
var hash=decodeURI(location.hash);
if(''==hash||hash.indexOf('#')>0){
	location.href='index.html';//没有按规定格式访问则回到首页
}
hash =hash.replace('#','');
let obj=qs.parse(hash);
var strcnos=obj.cnos;
var cnos=strcnos.split(",");
let yc_login=new Vue({
	el:"#yc_login",//对应div的id,即这个vue的作用域
	data:{
		onlogin:false,
		outlogin:true,
		user:{},
		carts:{},
		buyCarts:{},
		goodsCount:0,
		totalPrice:0,//总价格
		money:[],
		detail:'',
		goodsCount:0,
		i:0,
		j:0,
		provs:['北京','河北','山东'],
		cities:[
            ['东城','西城','海淀','朝阳'],
            ['石家庄','保定','唐山','廊坊'],
            ['济南','青岛','烟台','德州']
        ],
        pcode:"",
        detailAddr:"",
        word:"",
        receiver:"",
        tel:""
	},
	mounted:function(){//数据挂载之前，相当于jquery中的$(function(){}),页面加载完成
		axios({
			url:'member.action?op=check',
			method:'get'
		}).then(result=>{
			if(result.data.member){//说明登录了
				this.onlogin=true;
				this.outlogin=false;
				this.user=result.data.member;
				this.receiver=result.data.member.nickName;
				this.tel=result.data.member.tel;
				var strs=new Array();
				strs=result.data.member.addr.split("-");
				this.detail=strs[2];
				for(var k=0;k<this.provs.length;k++){
					if(this.provs[k]==strs[0]){
						this.i=k;
						for(var k1=0;k1<this.cities[k].length;k1++){
							if(this.cities[k][k1]==strs[1]){
								this.j=k1;
								break;
							}
						}
						break;
					}
				}
				if(result.data.carts){
					this.carts=result.data.carts;
					this.goodsCount=result.data.carts.length;
				}
			}else{
				this.onlogin=false;
				this.outlogin=true;
				alert('请先登录。。。');
				location.href='login.html';
			}
		});
		axios.post('cart.action',qs.stringify({op:'find',cnos:cnos})).then(result=>{
			this.buyCarts=result.data;//List<CartVO> list=biz.findByMnoVO(menber.getMno());
			//购物车中每行数据进行循环
			result.data.forEach((item,index)=>{
				this.money.push(item.price*item.num);
				this.totalPrice+=item.num*item.price;
			});
		});
	},
	methods:{
		out:function(){
			axios({url:'member.action?op=out',method:'get'})
			.then(result=>{
				let data=result.data;
				if(data==1){
					location.href='login.html';
				}else{
					alert('退出失败！！');
					return ;
				}
			});
		},
		genOrder:function(){
			if(this.pcode==""||this.detailAddr==""||this.receiver==""||this.tel==""){
				alert("必要信息未填全！！");
				return;
			}
			var cnos=new Array();
			this.buyCarts.forEach((item,index)=>{
				cnos.push(item.cno);
			});
			var sizenos=new Array();
			this.buyCarts.forEach((item,index)=>{
				sizenos.push(item.sizeno);
			});
			var nums=new Array();
			this.buyCarts.forEach((item,index)=>{
				nums.push(item.num);
			});
			this.check(nums,sizenos);
		},
		sub:function(){
			//发送请求
			var addr=this.provs[this.i]+"-"+this.cities[this.i][this.j]+"-"+this.detail;
			var detailAddr=this.detailAddr;
			var tel=this.tel;
			var pCode=this.pcode;
			var descr=this.word;
			var receiver=this.receiver;
			axios.post("order.action",qs.stringify({op:'add',descr:descr,receiver:receiver,pCode:pCode,tel:tel,cnos:cnos,detailAddr:detailAddr,addr:addr}))
			.then(result=>{
				//如果订单生成成功，返回订单编号
				let data=result.data;
				if(data>0){
					location.href='payply.html#'+data+"&"+this.totalPrice;//data orderid
				}else if(data==-1){
					alert("请先取消或者支付--》》未支付的在线订单！");
					location.href="buyRecord.html";
				}else{
					alert('下单失败，请稍后重试。。。')
				}
			});
		},
		check:function(nums,sizenos){
			axios.post('goodDetailServlet.action',qs.stringify({op:'check',nums:nums,sizenos:sizenos})).then(result=>{
				if(result.data=="ok"){
					this.sub();
				}else if(result.data==""){
					alert('请检查订单中是否有商品');
					location.href="shopcar.html";
					return ;
				}else if(result.data==null){
					alert('提交失败，请重试！');
					location.href="shopcar.html";
					return ;
				}else{
					alert(result.data);
					location.href="shopcar.html";
					return ;
				}
			});
		}
	}
});
</script>
</body>
</html>
