<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>提交订单信息</title>
    <link href="css/style.css" type="text/css" rel="stylesheet"/>
    <script src="js/jquery-1.7.min.js" type="text/javascript"></script>
    <script src="js/common.js" type="text/javascript"></script>
    <script src="/webjars/vue/2.5.16/dist/vue.min.js"></script>
    <script src="/webjars/axios/0.21.1/dist/axios.min.js"></script>
    <script src="js/shop.js"></script>
</head>
<body class="index">
<div class="top_ad">
    <div class="w1200"><a href="#" id="close"></a></div>
</div>
<div class="top">
    <div id="login-body">
        <login-body></login-body>
    </div>

    <script>
        let loginVue = new Vue({
            el: "#login-body"
        });
    </script>

    <div class="head" id="head-body">
        <shop-cart></shop-cart>
    </div>
    <script>
        let headVue = new Vue({
            el: "#head-body"
        });
    </script>
</div>


<div style="margin-top: 130px" class="w1200">
    <div class="position"><a href="index.html">首页</a> > <a href="shopcar.html">购物车</a></div>

    <div class="shopcar" id="confirm-body">
        <div class="info_lc"><span class="sp01">我的购物车</span><span class="sp02">填写提交信息表单</span><span
                class="sp03">在线支付</span>
        </div>

        <dl class="info">
            <dt><span>确认收货地址</span></dt>
            <dd>
                <div class="item"><span><font>*</font>所在地区：</span>
                    <select v-model="i">
                        <option v-for='(prov,index) of provs' :key='index' :value='index' v-text='prov'></option>
                    </select>
                    <select v-model="j">
                        <option v-for='(city,index) of cities[i]' :key='index' :value='index'
                                v-text='city'></option>
                    </select>
                    <input type="text" class="txt" v-model="detail"/>
                </div>
                <div class="item"><span><font>*</font>邮政编码：</span><input type="text" class="txt" v-model="pcode"/>
                </div>
                <div class="item">
                    <table width="100%" border="0" cellspacing="0" cellpadding="0">
                        <tr>
                            <td width="8%"><span><font>*</font>详细地址：</span></td>
                            <td width="92%"><textarea v-model="detailAddr"></textarea></td>
                        </tr>
                    </table>
                </div>
                <div class="item"><span><font>*</font>收货人姓名：</span><input type="text" class="txt"
                                                                          v-model="receiver"/></div>
                <div class="item"><span><font>*</font>手机：</span><input type="text" class="txt" v-model="tel"/></div>
            </dd>
        </dl>

        <dl>
            <dt><span>确认订单信息</span></dt>
            <dd>
                <table width="100%" cellpadding="0" cellspacing="0" border="0">
                    <tr class="tr_t">
                        <td width="2%">&nbsp;</td>
                        <td width="48%">商品</td>
                        <td width="25%">单价</td>
                        <td width="13%">数量</td>
                        <td width="12%">小计</td>
                    </tr>
                    <tr class="tr_c" v-for="(item,index) in buyCarts">
                        <td>&nbsp;</td>
                        <td>
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="15%"><img :src="item.showPic"/></td>
                                    <td width="85%"><a :href="'product_show.html#'+item.sizeno" class="title">{{item.gname}}-{{item.size}}</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td class="price">￥ {{item.price}}</td>
                        <td>{{item.num}}</td>
                        <td class="price">￥ {{money[index]}}</td>
                    </tr>
                    <tr class="tr_d">
                        <td colspan="7">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="3%">&nbsp;</td>
                                    <td width="6%">买家留言：</td>
                                    <td width="75%"><input v-model="word" type="text" class="msg"/></td>
                                    <td width="6%">应付金额：</td>
                                    <td width="10%" class="all_price"><font>￥ {{totalPrice}}</font></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                <div class="clear"></div>

            </dd>
        </dl>
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="go_tb">
            <tr>
                <td width="20%"><a href="product.html" class="go_buy">继续购物</a></td>
                <td width="63%">&nbsp;</td>
                <td width="17%" align="right"><a href="javascript:void(0)" @click="genOrder()" class="code">结 算</a>
                </td>
            </tr>
        </table>
        <div class="clear"></div>
    </div>
</div>
<!--footer-->
<div id="footer-body">
    <footer-body></footer-body>
</div>
<script>
    let footerVue = new Vue({
        el: "#footer-body"
    });
</script>
<!--float_right-->
<div class="float">
    <ul>
        <li><a href="#" class="a01"></a></li>
        <li><a href="#" class="a02"></a></li>
        <li><a href="#" class="a03"></a></li>
        <li><a href="#" class="a04"></a></li>
    </ul>
</div>
<script type="text/javascript" src="js/qs.js"></script>
<script>
    let hash = decodeURI(location.hash);
    if ('' == hash || hash.indexOf('#') > 0) {
        location.href = 'index.html';//没有按规定格式访问则回到首页
    }
    hash = hash.replace('#', '');
    let obj = qs.parse(hash);
    let strcnos = obj.cnos;
    let cnos = strcnos.split(",");
    let confirmVue = new Vue({
        el: "#confirm-body",//对应div的id,即这个vue的作用域
        data: {
            user: {},
            carts: {},
            buyCarts: {},
            goodsCount: 0,
            totalPrice: 0,//总价格
            money: [],
            detail: '',
            goodsCount: 0,
            i: 0,
            j: 0,
            provs: ['北京', '河北', '山东'],
            cities: [
                ['东城', '西城', '海淀', '朝阳'],
                ['石家庄', '保定', '唐山', '廊坊'],
                ['济南', '青岛', '烟台', '德州']
            ],
            receiver: "",
            pcode: "",
            detailAddr: "",
            word: "",
            tel: ""
        },
        created: function () {//数据挂载之前，相当于jquery中的$(function(){}),页面加载完成
            axios({
                url: 'member.action?op=check',
                method: 'get'
            }).then(result => {
                if (result.data.member) {//说明登录了
                    this.onlogin = true;
                    this.outlogin = false;
                    this.user = result.data.member;
                    this.receiver = result.data.member.nickName;
                    this.tel = result.data.member.tel;
                    var strs = new Array();
                    strs = result.data.member.addr.split("-");
                    this.detail = strs[2];
                    for (var k = 0; k < this.provs.length; k++) {
                        if (this.provs[k] == strs[0]) {
                            this.i = k;
                            for (var k1 = 0; k1 < this.cities[k].length; k1++) {
                                if (this.cities[k][k1] == strs[1]) {
                                    this.j = k1;
                                    break;
                                }
                            }
                            break;
                        }
                    }
                    if (result.data.carts) {
                        this.carts = result.data.carts;
                        this.goodsCount = result.data.carts.length;
                    }
                } else {
                    this.onlogin = false;
                    this.outlogin = true;
                    alert('请先登录。。。');
                    location.href = 'login.html';
                }
            });
            axios.post('cart.action', qs.stringify({op: 'find', cnos: cnos})).then(result => {
                this.buyCarts = result.data;//List<CartVO> list=biz.findByMnoVO(menber.getMno());
                //购物车中每行数据进行循环
                result.data.forEach((item, index) => {
                    this.money.push(item.price * item.num);
                    this.totalPrice += item.num * item.price;
                });
            });
        },
        methods: {
            genOrder: function () {
                if (this.pcode == "" || this.detailAddr == "" || this.receiver == "" || this.tel == "") {
                    alert("必要信息未填全！！");
                    return;
                }
                var cnos = new Array();
                this.buyCarts.forEach((item, index) => {
                    cnos.push(item.cno);
                });
                var sizenos = new Array();
                this.buyCarts.forEach((item, index) => {
                    sizenos.push(item.sizeno);
                });
                var nums = new Array();
                this.buyCarts.forEach((item, index) => {
                    nums.push(item.num);
                });
                this.check(nums, sizenos);
            },
            sub: function () {
                //发送请求
                var addr = this.provs[this.i] + "-" + this.cities[this.i][this.j] + "-" + this.detail;
                var detailAddr = this.detailAddr;
                var tel = this.tel;
                var pCode = this.pcode;
                var descr = this.word;
                var receiver = this.receiver;
                axios.post("order.action", qs.stringify({
                    op: 'add',
                    descr: descr,
                    receiver: receiver,
                    pCode: pCode,
                    tel: tel,
                    cnos: cnos,
                    detailAddr: detailAddr,
                    addr: addr
                })).then(result => {
                    //如果订单生成成功，返回订单编号
                    let data = result.data;
                    if (data > 0) {
                        location.href = 'payply.html#' + data + "&" + this.totalPrice;//data orderid
                    } else if (data == -1) {
                        alert("请先取消或者支付--》》未支付的在线订单！");
                        location.href = "buyRecord.html";
                    } else {
                        alert('下单失败，请稍后重试。。。')
                    }
                });
            },
            check: function (nums, sizenos) {
                axios.post('goodDetailServlet.action', qs.stringify({
                    op: 'check',
                    nums: nums,
                    sizenos: sizenos
                })).then(result => {
                    if (result.data == "ok") {
                        this.sub();
                    } else if (result.data == "") {
                        alert('请检查订单中是否有商品');
                        location.href = "shopcar.html";
                        return;
                    } else if (result.data == null) {
                        alert('提交失败，请重试！');
                        location.href = "shopcar.html";
                        return;
                    } else {
                        alert(result.data);
                        location.href = "shopcar.html";
                        return;
                    }
                });
            }
        }
    });
</script>
</body>
</html>
